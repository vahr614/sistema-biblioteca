<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Deudores</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css">
    <style>
        .form-label { font-size: 0.8rem; font-weight: 700; color: #6c757d; letter-spacing: 0.5px; }
        .card-header { border-bottom: 0; }
        .table-hover tbody tr:hover { background-color: #ffe5e5; }
    </style>
</head>
<body class="bg-light">

<div class="container py-4">
    
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold mb-0 text-danger">
            <i class="fas fa-ban"></i> Lista Negra (Deudores)
        </h2>
        <a href="/admin" class="btn btn-outline-secondary px-4 shadow-sm">
            <i class="fas fa-arrow-left me-1"></i> Volver
        </a>
    </div>

    {% with messages = get_flashed_messages() %}
        {% if messages %}
            <div class="alert alert-info shadow-sm border-0 mb-4 rounded-3">
                <i class="fas fa-info-circle me-2"></i> {{ messages[0] }}
            </div>
        {% endif %}
    {% endwith %}

    <div class="card shadow-sm border-0 mb-4 rounded-4">
        <div class="card-header bg-danger text-white py-3 rounded-top-4">
            <h5 class="mb-0 fw-bold"><i class="fas fa-user-lock me-2"></i> Bloquear Nuevo Usuario</h5>
        </div>
        <div class="card-body p-4">
            <form method="POST">
                
                <div class="row g-3 mb-3">
                    <div class="col-12">
                        <label class="form-label">DNI O CÓDIGO A BLOQUEAR</label>
                        <div class="input-group">
                            <span class="input-group-text bg-light"><i class="fas fa-id-card"></i></span>
                            <input type="text" name="identificador" class="form-control" required placeholder="Ingrese DNI o Voucher" style="max-width: 300px;">
                        </div>
                    </div>
                </div>

                <div class="row g-3 mb-3">
                    <div class="col-12 col-md-4">
                        <label class="form-label">APELLIDO PATERNO</label>
                        <input type="text" name="paterno" class="form-control" required placeholder="Ej: PEREZ" oninput="this.value = this.value.toUpperCase()">
                    </div>
                    <div class="col-12 col-md-4">
                        <label class="form-label">APELLIDO MATERNO</label>
                        <input type="text" name="materno" class="form-control" required placeholder="Ej: LOPEZ" oninput="this.value = this.value.toUpperCase()">
                    </div>
                    <div class="col-12 col-md-4">
                        <label class="form-label">NOMBRES</label>
                        <input type="text" name="nombres" class="form-control" required placeholder="Ej: JUAN CARLOS" oninput="this.value = this.value.toUpperCase()">
                    </div>
                </div>
                
                <div class="row g-3 mb-3">
                    <div class="col-12 col-md-4">
                        <label class="form-label">TIPO DE USUARIO</label>
                        <select name="tipo" class="form-select">
                            <option value="ALUMNO">ALUMNO</option>
                            <option value="EGRESADO">EGRESADO</option>
                            <option value="DOCENTE">DOCENTE</option>
                            <option value="EXTERNO">EXTERNO</option>
                        </select>
                    </div>
                    <div class="col-12 col-md-4">
                        <label class="form-label">FACULTAD</label>
                        <select name="facultad" id="selectFacultad" class="form-select">
                            <option value="">-- Seleccione --</option>
                            {% for f in facultades %}
                                <option value="{{ f.id }}">{{ f.nombre }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-12 col-md-4">
                        <label class="form-label">ESCUELA / CARRERA</label>
                        <select name="escuela" id="selectEscuela" class="form-select" disabled>
                            <option value="">Seleccione Facultad primero</option>
                        </select>
                        <input type="hidden" name="escuela_nombre" id="inputEscuelaNombre">
                    </div>
                </div>

                <div class="mb-4">
                    <label class="form-label">MOTIVO DEL BLOQUEO</label>
                    <input type="text" name="motivo" class="form-control" required placeholder="Ej: Libro 'Anatomía Humana' no devuelto desde 2023">
                </div>

                <button class="btn btn-danger w-100 fw-bold py-3 rounded-3 shadow-sm transition-hover">
                    <i class="fas fa-lock me-2"></i> REGISTRAR BLOQUEO
                </button>
            </form>
        </div>
    </div>

    <div class="card shadow-sm border-0 rounded-4">
        <div class="card-body p-0">
            <div class="table-responsive p-3">
                <table id="tablaDeudores" class="table table-hover w-100 align-middle">
                    <thead class="table-light">
                        <tr>
                            <th class="text-danger">ID / DNI</th>
                            <th>Apellidos y Nombres</th>
                            <th>Motivo</th>
                            <th>Facultad</th>
                            <th class="text-end">Acción</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for d in deudores %}
                        <tr>
                            <td class="fw-bold text-danger">{{ d.identificador }}</td>
                            <td>
                                <span class="fw-bold text-dark">{{ d.nombre }}</span>
                                <br><small class="text-muted badge bg-light text-secondary border">{{ d.tipo }}</small>
                            </td>
                            <td>{{ d.motivo }}</td>
                            <td><small class="text-muted">{{ d.facultad }}</small></td>
                            <td class="text-end">
                                <a href="{{ url_for('admin_eliminar_deudor', id=d.id) }}" class="btn btn-success btn-sm text-white shadow-sm" onclick="return confirm('¿Desbloquear a {{ d.nombre }}?')" title="Quitar de lista negra">
                                    <i class="fas fa-unlock me-1"></i> Desbloquear
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
<script>
    $(document).ready(function () {
        // Inicializar DataTables
        $('#tablaDeudores').DataTable({ 
            language: { url: "//cdn.datatables.net/plug-ins/1.13.4/i18n/es-ES.json" },
            order: [[ 0, "desc" ]]
        });

        // Lógica de carga dinámica de escuelas
        const selectFacultad = document.getElementById('selectFacultad');
        const selectEscuela = document.getElementById('selectEscuela');

        selectFacultad.addEventListener('change', function() {
            const idFacultad = this.value;
            
            if (!idFacultad) {
                selectEscuela.disabled = true;
                selectEscuela.innerHTML = '<option value="">Seleccione Facultad primero</option>';
                return;
            }

            selectEscuela.disabled = false;
            selectEscuela.innerHTML = '<option value="" disabled selected>Cargando...</option>';

            fetch(`/api/escuelas/${idFacultad}`)
                .then(response => response.json())
                .then(data => {
                    selectEscuela.innerHTML = '<option value="" disabled selected>-- Seleccione --</option>';
                    data.forEach(escuela => {
                        const option = document.createElement('option');
                        // Usamos el NOMBRE como valor
                        option.value = escuela.nombre; 
                        option.textContent = escuela.nombre;
                        selectEscuela.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Error:', error);
                    selectEscuela.innerHTML = '<option value="" disabled>Error al cargar</option>';
                });
        });
    });
</script>

</body>
</html>